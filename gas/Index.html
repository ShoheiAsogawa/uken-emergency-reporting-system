<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FX収支ダッシュボード</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>@view-transition { navigation: auto; }</style>
    <style><?!= include('style'); ?></style>
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="header-content">
          <h1 class="header-title" id="dashboard-title">FX収支ダッシュボード</h1>
          <div class="header-controls">
            <select class="filter-select" id="period-filter">
              <option value="week">今週</option>
              <option value="month" selected>今月</option>
              <option value="ytd">年初来</option>
              <option value="custom">カスタム</option>
            </select>
            <input type="text" class="search-input" id="search-input" placeholder="銘柄、戦略、ブローカーで検索..." />
            <button class="btn" id="add-trade-btn">取引を追加</button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <section class="kpi-section">
        <div class="container">
          <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-label">今日の損益</div><div class="kpi-value positive" id="today-pnl">+0円</div><div class="kpi-trend neutral">→ 0.0%</div></div>
            <div class="kpi-card"><div class="kpi-label">今月損益</div><div class="kpi-value positive" id="month-pnl">+0円</div><div class="kpi-trend neutral">→ 0.0%</div></div>
            <div class="kpi-card"><div class="kpi-label">勝率</div><div class="kpi-value neutral" id="win-rate">0.0%</div><div class="kpi-trend neutral">→ 0.0%</div></div>
            <div class="kpi-card"><div class="kpi-label">期待値/取引</div><div class="kpi-value positive" id="expectancy">+0円</div><div class="kpi-trend neutral">→ 0.0%</div></div>
            <div class="kpi-card"><div class="kpi-label">最大ドローダウン</div><div class="kpi-value negative" id="max-dd">0円</div><div class="kpi-trend neutral">→ 0.0%</div></div>
            <div class="kpi-card"><div class="kpi-label">PF（プロフィットファクター）</div><div class="kpi-value positive" id="profit-factor">0.00</div><div class="kpi-trend neutral">→ 0.0</div></div>
          </div>
        </div>
      </section>

      <section class="charts-section">
        <div class="container">
          <div class="chart-container"><h3 class="chart-title">エクイティカーブ & 月次損益</h3><canvas id="equity-chart" class="chart-canvas"></canvas></div>
        </div>
      </section>

      <section class="calendar-section">
        <div class="container">
          <div class="calendar-container">
            <div class="calendar-header">
              <h3 class="chart-title">取引カレンダー</h3>
              <div><button class="calendar-nav" id="prev-month">‹</button> <span id="calendar-month">2024年1月</span> <button class="calendar-nav" id="next-month">›</button></div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
          </div>
        </div>
      </section>

      <section class="trades-section">
        <div class="container">
          <div class="trades-container">
            <h3 class="chart-title">取引履歴</h3>
            <div class="trades-filters">
              <select class="filter-select" id="currency-filter">
                <option value="">全銘柄</option>
                <option value="USDJPY">USD/JPY</option>
                <option value="EURJPY">EUR/JPY</option>
                <option value="GBPJPY">GBP/JPY</option>
                <option value="AUDJPY">AUD/JPY</option>
                <option value="EURUSD">EUR/USD</option>
                <option value="GBPUSD">GBP/USD</option>
              </select>
              <select class="filter-select" id="strategy-filter">
                <option value="">全戦略</option>
                <option value="scalping">スキャルピング</option>
                <option value="swing">スイング</option>
                <option value="breakout">ブレイクアウト</option>
                <option value="reversal">リバーサル</option>
                <option value="trend">トレンドフォロー</option>
              </select>
              <select class="filter-select" id="session-filter">
                <option value="">全セッション</option>
                <option value="tokyo">東京</option>
                <option value="london">ロンドン</option>
                <option value="ny">ニューヨーク</option>
                <option value="overlap">重複</option>
              </select>
              <select class="filter-select" id="result-filter">
                <option value="">全結果</option>
                <option value="win">勝ち</option>
                <option value="loss">負け</option>
              </select>
            </div>
            <div class="table-container">
              <table class="trades-table" id="trades-table">
                <thead>
                  <tr>
                    <th data-col="date">日時</th>
                    <th data-col="pair">銘柄</th>
                    <th data-col="side">売買</th>
                    <th data-col="quantity">数量</th>
                    <th data-col="entry">建値</th>
                    <th data-col="exit">決済</th>
                    <th data-col="pnl">損益(JPY)</th>
                    <th data-col="rr">RR</th>
                    <th data-col="strategy">戦略</th>
                    <th data-col="session">セッション</th>
                    <th data-col="broker">ブローカー</th>
                  </tr>
                </thead>
                <tbody id="trades-tbody"></tbody>
              </table>
            </div>
            <div id="trades-empty" class="empty-state" style="display: none;">
              <div class="empty-state-icon">📊</div>
              <div class="empty-state-title">まだ取引がありません</div>
              <div class="empty-state-text">まずは「取引を追加」を押してください。</div>
              <button class="btn" id="empty-add-trade">取引を追加</button>
            </div>
          </div>
        </div>
      </section>

      <section class="analysis-section">
        <div class="container">
          <div class="analysis-grid">
            <div class="chart-container"><h3 class="chart-title">銘柄別損益ランキング</h3><canvas id="currency-chart" class="chart-canvas"></canvas></div>
            <div class="chart-container"><h3 class="chart-title">時間帯別パフォーマンス</h3><canvas id="session-chart" class="chart-canvas"></canvas></div>
            <div class="chart-container"><h3 class="chart-title">戦略別勝率・期待値</h3><canvas id="strategy-chart" class="chart-canvas"></canvas></div>
            <div class="chart-container"><h3 class="chart-title">RR分布</h3><canvas id="rr-chart" class="chart-canvas"></canvas></div>
          </div>
        </div>
      </section>

      <section class="goals-section">
        <div class="container">
          <div class="goals-container">
            <h3 class="chart-title">目標とアラート</h3>
            <div>
              <div class="kpi-label">月次目標進捗 (目標: <span id="monthly-target">100,000円</span>)</div>
              <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div>
              <div style="display:flex;justify-content:space-between;font-size:14px;margin-top:8px;"><span class="positive" id="progress-current">現在: 0円</span><span class="neutral" id="progress-percent">0%</span></div>
            </div>
            <div style="margin-top: 24px;">
              <div class="kpi-label">連勝・連敗カウンタ</div>
              <div style="display: flex; gap: 20px; margin-top: 12px;">
                <div><span class="kpi-label">現在の連勝: </span> <span class="positive" id="win-streak">0回</span></div>
                <div><span class="kpi-label">最大連敗: </span> <span class="negative" id="max-loss-streak">0回</span></div>
              </div>
            </div>
            <div class="alert-banner hidden" id="streak-alert">⚠️ 連敗が続いています。リスクを再確認しましょう。</div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h4>キーボードショートカット</h4>
            <p>Ctrl + N: 新規取引追加</p>
            <p>Ctrl + F: 検索</p>
            <p>Ctrl + D: 今日の取引表示</p>
          </div>
          <div class="footer-section">
            <h4>データについて</h4>
            <p>• 損益は手数料・スワップ込みのnet表示</p>
            <p>• 期待値 = 平均損益/取引</p>
            <p>• PF = 総利益/総損失</p>
            <p>• データは遅延する場合があります</p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Trade Modal -->
    <div class="modal" id="trade-modal" aria-hidden="true" role="dialog" aria-label="取引を追加">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">取引を追加</h2>
          <button class="close-btn" id="close-modal">×</button>
        </div>
        <form id="trade-form">
          <div class="form-row">
            <div class="form-group"><label class="form-label" for="trade-date">取引日時 *</label><input type="datetime-local" class="form-input" id="trade-date" required /></div>
            <div class="form-group"><label class="form-label" for="currency-pair">通貨ペア *</label>
              <select class="form-select" id="currency-pair" required>
                <option value="">選択してください</option>
                <option value="USDJPY">USD/JPY</option>
                <option value="EURJPY">EUR/JPY</option>
                <option value="GBPJPY">GBP/JPY</option>
                <option value="AUDJPY">AUD/JPY</option>
                <option value="EURUSD">EUR/USD</option>
                <option value="GBPUSD">GBP/USD</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label" for="side">売買 *</label>
              <select class="form-select" id="side" required>
                <option value="">選択してください</option>
                <option value="buy">買い</option>
                <option value="sell">売り</option>
              </select>
            </div>
            <div class="form-group"><label class="form-label" for="quantity">数量 *</label><input type="number" class="form-input" id="quantity" step="0.01" required /></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label" for="entry-price">エントリー価格 *</label><input type="number" class="form-input" id="entry-price" step="0.001" required /></div>
            <div class="form-group"><label class="form-label" for="exit-price">決済価格 *</label><input type="number" class="form-input" id="exit-price" step="0.001" required /></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label" for="fees">手数料・スワップ</label><input type="number" class="form-input" id="fees" step="0.01" value="0" /></div>
            <div class="form-group"><label class="form-label" for="pnl-display">損益(JPY)</label><input type="text" class="form-input" id="pnl-display" readonly /></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label" for="strategy-tag">戦略タグ</label>
              <select class="form-select" id="strategy-tag">
                <option value="">選択してください</option>
                <option value="scalping">スキャルピング</option>
                <option value="swing">スイング</option>
                <option value="breakout">ブレイクアウト</option>
                <option value="reversal">リバーサル</option>
                <option value="trend">トレンドフォロー</option>
              </select>
            </div>
            <div class="form-group"><label class="form-label" for="session">セッション</label>
              <select class="form-select" id="session">
                <option value="">選択してください</option>
                <option value="tokyo">東京</option>
                <option value="london">ロンドン</option>
                <option value="ny">ニューヨーク</option>
                <option value="overlap">重複</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label" for="broker">ブローカー</label><input type="text" class="form-input" id="broker" placeholder="例: XM, OANDA" /></div>
            <div class="form-group"><label class="form-label" for="screenshot-url">スクリーンショットURL</label><input type="url" class="form-input" id="screenshot-url" placeholder="https://..." /></div>
          </div>
          <div class="form-group"><label class="form-label" for="notes">メモ・ノート</label><textarea class="form-textarea" id="notes" placeholder="取引の詳細、反省点など..."></textarea></div>
          <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;"><button type="button" class="btn btn-secondary" id="cancel-btn">キャンセル</button> <button type="submit" class="btn" id="submit-btn"><span class="spinner" id="submit-spinner" style="display:none;"></span>保存</button></div>
        </form>
      </div>
    </div>

    <script><?!= include('app'); ?></script>
  </body>
  </html>

